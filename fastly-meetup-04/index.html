<!doctype html><html lang=en><head><meta charset=utf-8><title>Code over Configuration 〜 Compute@Edge は VCL に置き換わるのか</title><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=canonical href=https://yusukebe.github.io/slides/fastly-meetup-04/><meta property="og:title" content="Code over Configuration 〜 Compute@Edge は VCL に置き換わるのか &ndash; yusukebe/slides"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://yusukebe.github.io/slides/fastly-meetup-04/"><meta property="og:image" content="https://yusukebe.github.io/slides/fastly-meetup-04/cover.png"><meta property="og:site_name" content="yusukebe/slides"><meta name=twitter:card content="summary_large_image"><meta name=twitter:domain content="yusukebe.github.com"><meta name=twitter:title content="Code over Configuration 〜 Compute@Edge は VCL に置き換わるのか &ndash; yusukebe/slides"><meta name=twitter:description content><link rel=stylesheet href=/slides/reveal-js/css/reset.css><link rel=stylesheet href=/slides/reveal-js/css/reveal.css><link rel=stylesheet href=/slides/_.min.987502fe84ada46c1007ceba381f024831c3f8a91da4d3557a6728583666d6aa.css id=theme><link rel=stylesheet href=/slides/highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h1 id=code-over-configuration--computeedge-は-vcl-に置き換わるのか>Code over Configuration 〜 Compute@Edge は VCL に置き換わるのか</h1><p>2022-03-29 Fastly User Meetup #4</p><p>Yusuke Wada</p></section><section><h2 id=トラベルブック>トラベルブック</h2><ol><li>「旅行商品比較サイト」</li><li>「旅行・ライフスタイルメディア」</li></ol><p>テックブログやってます。</p><p>TravelBook Tech Blog<br><a href=https://tech.travelbook.co.jp/>https://tech.travelbook.co.jp/</a></p></section><section><h2 id=アジェンダ>アジェンダ</h2><p>「Compute@EdgeはVCLに置き換わるのか？」</p><ol><li>機能</li><li>開発</li><li>性能</li></ol></section><section><p>今回、Compute@EdgeはJavaScriptによる実装を前提としています</p><p>全て個人の見解です！(間違っているところあると思います)</p></section><section><h1 id=イントロ>イントロ</h1></section><section><h2 id=cdnのエッジで実行する系いろいろ>CDNのエッジで実行する系いろいろ</h2><ul><li>Cloudflare Workers</li><li>Fastly Compute@Edge</li><li>AWS CloudFront Functions</li><li>AWS Lambda@Edge</li><li>Deno Deploy</li><li>Vercel Edge Functions</li><li>Netlify Functions</li></ul><p>CDNのエッジで実行する系が面白い - ゆーすけべー日記
<a href=https://yusukebe.com/posts/2021/functions-at-edge/>https://yusukebe.com/posts/2021/functions-at-edge/</a></p></section><section><h2 id=中でもcloudflare-workersとcomputeedgeの比較>中でもCloudflare WorkersとCompute@Edgeの比較</h2><p>JavaScriptにおいては、どちらもService Worker互換</p><p>使ってみて</p></section><section><h3 id=cloudflare-workers>Cloudflare Workers</h3><ul><li>アプリケーション寄り</li><li>KV、Durable Objectsなど</li><li>例: Remixが動く</li></ul><p>Supporting Remix with full stack Cloudflare Pages
<a href=https://blog.cloudflare.com/remix-on-cloudflare-pages/>https://blog.cloudflare.com/remix-on-cloudflare-pages/</a></p></section><section><h3 id=fastly-computeedge>Fastly Compute@Edge</h3><ul><li>FastlyはCDNが強い</li><li>Compute@Edgeはバックエンドがないと警告が出る<ul><li>＊そのうち変わるかもしれない</li></ul></li></ul><p><img src=ss01.png alt=SS></p></section><section><p>DOOMのようなアプリケーション寄りのデモもあるが&mldr;</p><p><img src=ss02.png alt=SS></p><p>DOOM | Fastly Developer Hub
<a href=https://developer.fastly.com/solutions/demos/doom/>https://developer.fastly.com/solutions/demos/doom/</a></p></section><section><p>Fastly Compute@Edgeは「<strong>CDNに強い</strong>」</p></section><section><h2 id=余談>余談</h2><p>Fastly vs Cloudflare</p><ul><li><strong>Cloudflare</strong>: ネットワークパフォーマンスの最新情報：Full Stack Week <a href=https://blog.cloudflare.com/ja-jp/network-performance-update-full-stack-week-ja-jp/>https://blog.cloudflare.com/ja-jp/network-performance-update-full-stack-week-ja-jp/</a></li><li><strong>Fastly</strong>: 嘘、大嘘、そして (Cloudflareの) 統計 : Cloudflareのパフォーマンステストの欠陥を証明 | Fastly <a href=https://www.fastly.com/jp/blog/debunking-cloudflares-recent-performance-tests>https://www.fastly.com/jp/blog/debunking-cloudflares-recent-performance-tests</a></li></ul></section><section><p>CDNに強い？</p><p>=> バックエンドを活かす</p></section><section><h3 id=ただしfastlyにはvclがある>ただし、FastlyにはVCLがある</h3><p><em>Varnish Configuration Language</em></p><p>あくまで<strong>Varnish</strong>（キャッシュサーバ）の<strong>設定言語</strong></p></section><section><p>VCLでできることはCompute@Edgeでできるのではないか？</p></section><section><blockquote><p>Code over Configuration</p></blockquote></section><section><p>「Edge Functions – Vercel」のページより</p><p><a href=https://vercel.com/features/edge-functions>https://vercel.com/features/edge-functions</a></p><p><img src=ss03.png alt=SS></p></section><section><h2 id=computeedgeはvclに置き換わるのか>Compute@EdgeはVCLに置き換わるのか</h2><ol><li>機能</li><li>開発</li><li>性能</li></ol></section><section><h1 id=1-機能>1. 機能</h1></section><section><h3 id=migrate-from-vclというドキュメントがある>「Migrate from VCL」というドキュメントがある</h3><p>Migrate from VCL | Fastly Developer Hub
<a href=https://developer.fastly.com/learning/compute/migrate/>https://developer.fastly.com/learning/compute/migrate/</a></p></section><section><h3 id=how-we-migrated-developerfastlycom-from-vcl-to-computeedgeという記事もある>「How we migrated developer.fastly.com from VCL to Compute@Edge」という記事もある</h3><p>2022/03/16</p><p>How we migrated developer.fastly.com from VCL to Compute@Edge | Fastly<br><a href=https://www.fastly.com/blog/how-we-migrated-developer-fastly-com-from-vcl-to-compute-edge>https://www.fastly.com/blog/how-we-migrated-developer-fastly-com-from-vcl-to-compute-edge</a></p></section><section><p>Compute@Edgeでできること</p></section><section><p>Configuration</p><ul><li>Edge dictionaryから設定データを取得する</li></ul></section><section><p>Request</p><ul><li>リクエストヘッダを追加する</li><li>クエリストリングのソートとサニタイズ</li><li>リクエストからクエリストリングを抜き出す</li><li>リクエストから特定のヘッダを削除する</li><li>リクエストパスを変更する</li><li>特定のヘッダが存在するか確認する</li><li>ヘッダの値に指定した文字列が存在するか確認する</li><li>リクエストボディを取得する</li><li>クライアントのGeo情報を取得する</li></ul></section><section><p>Backends</p><ul><li>リクエストのパスごとにバックエンドを切り替える</li><li>エラーが起きたらもう一つのバックエンドを使う</li></ul></section><section><p>Response</p><ul><li>スクラッチでレスポンスを作成する</li><li>画像を返す</li><li>レスポンスヘッダを設定する</li></ul></section><section><p>Controlling the cache</p><ul><li>明示的にTTLを設定する</li><li>強制的にpassする</li><li>SWRを指定する</li></ul></section><section><h2 id=トラベルブックがvclでやってることもほぼ全てカバー>トラベルブックがVCLでやってることもほぼ全てカバー</h2></section><section><p>トラベルブックがやってること1</p><ul><li>Edge Dictionary</li><li>UAによるステータスコードの変更</li><li>Basic認証</li><li>検証かどうか環境の判定</li><li>リクエストメソッドによる分岐</li><li>クッキーのありなしの判定</li><li>デバイス判定</li><li>パスによるバックエンドの変更</li></ul></section><section><p>トラベルブックがやってること2</p><ul><li>キャッシュキーの作成（URL、デバイス、ホスト）</li><li>ステータスコードでキャッシュの有無</li><li>パスによってTTLを変更</li><li>SWR、Stale-IF-Errorの設定</li><li>レスポンスヘッダの設定（x-ttl）</li><li>Varyヘッダの変更</li><li>サロゲートキーの生成</li><li>エラーの場合、S3のエラーページを表示</li><li>401のsyntheticレスポンスの変更</li><li>noindexヘッダ</li><li>ユニークIDの生成（sha256）</li></ul></section><section><h2 id=工夫が必要なもの>工夫が必要なもの</h2></section><section><h3 id=http3---alt-svcヘッダの追加-h3alt_svc>HTTP/3 - alt svcヘッダの追加 <code>h3.alt_svc()</code></h3><p>自分でヘッダに足す</p></section><section><h3 id=brotoligzipの設定-set-berespgzip--true>Brotoli、Gzipの設定 <code>set beresp.gzip = true</code></h3><p>X-Compress-Hint | Fastly Developer Hub
<a href=https://developer.fastly.com/reference/http/http-headers/X-Compress-Hint/>https://developer.fastly.com/reference/http/http-headers/X-Compress-Hint/</a></p></section><section><h2 id=たぶんできないこと>(たぶん)できないこと</h2></section><section><ul><li>ACL <code>client.ip ~ ${ip_block_acl_name}</code></li><li><code>Fastly-Debug:1</code>ヘッダが効かない => 自分でやれ？</li><li>実験的な機能、 <code>h2.early_hints</code></li></ul></section><section><h2 id=注意したほうがいいこと>注意したほうがいいこと</h2></section><section><ul><li>環境変数が使えない => Edge Dictionaryで変数を管理する</li></ul><p>Fastly Compute@Edgeについて分かったこと – TravelBook Tech Blog<br><a href=https://tech.travelbook.co.jp/posts/fastly-compute-at-edge/>https://tech.travelbook.co.jp/posts/fastly-compute-at-edge/</a></p></section><section><p>ほぼ全ての機能をCompute@Edgeがカバー</p></section><section><h3 id=逆にcomputeedgeだからできる機能>逆にCompute@Edgeだからできる機能</h3><p>例</p><ul><li>ダイナミックに<code>Link</code>ヘッダをつける</li><li>Signed Exchange</li><li>FUJIMIさんの例 => Preview URLの発行</li></ul><p>sxg-rs/fastly_compute at main · google/sxg-rs
<a href=https://github.com/google/sxg-rs/tree/main/fastly_compute>https://github.com/google/sxg-rs/tree/main/fastly_compute</a></p></section><section><h3 id=要望>要望</h3><ul><li>パスごとにVCL、Computeと分けたい &lt;= 今だとプロジェクト単位</li></ul></section><section><h1 id=2-開発>2. 開発</h1></section><section><blockquote><p>(あらためて)JavaScriptで書ける！！</p></blockquote></section><section><h2 id=vcl>VCL</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>set obj<span style=color:#f92672>.</span>status <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
</span></span><span style=display:flex><span>synthetic <span style=color:#e6db74>&#34;Hello world&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span>(deliver);
</span></span></code></pre></div></section><section><h2 id=computeedge>Compute@Edge</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handleRequest</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>request</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#e6db74>&#34;Compute@Edge!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;fetch&#34;</span>, <span style=color:#a6e22e>event</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>respondWith</span>(<span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>))
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></section><section><h2 id=codeである意味>Codeである意味</h2><ol><li>標準であること</li><li>再利用性</li><li>仮想環境</li><li>テスト</li></ol></section><section><p>Codeである意味</p><h2 id=1-標準であること>1. 標準であること</h2></section><section><h2 id=service-worker-like-api>Service Worker (like) API</h2></section><section><p><img src=ss04.png alt=SS></p><p>Fetch API - Web API | MDN
<a href=https://developer.mozilla.org/ja/docs/Web/API/Fetch_API>https://developer.mozilla.org/ja/docs/Web/API/Fetch_API</a></p></section><section><h3 id=標準のapiが使える>標準のAPIが使える</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URL</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span>).<span style=color:#a6e22e>pathname</span> <span style=color:#75715e>// Request, URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ua</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;User-Agent&#39;</span>) <span style=color:#75715e>// Headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#39;X-Debug&#39;</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span><span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ua</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>) <span style=color:#75715e>// Response
</span></span></span></code></pre></div></section><section><h3 id=fastlyjs-compute><code>@fastly/js-compute</code></h3><ul><li>Dictionary</li><li>Env</li><li>Headers</li><li>Request</li><li>Response</li><li>TextDecoder</li><li>TextEncoder</li><li>URL</li><li>URLSearchParams</li></ul><p>@fastly/js-compute - v0.2.4 | @fastly/js-compute - v0.2.4
<a href=https://js-compute-reference-docs.edgecompute.app/>https://js-compute-reference-docs.edgecompute.app/</a></p></section><section><p>TypeScriptでも書ける</p><p>TS => JS => Wasm</p></section><section><h2 id=型がある>型がある</h2><p><img src=ss05.png alt=SS>
<img src=ss06.png alt=SS></p></section><section><p>Codeである意味</p><h2 id=2-再利用性>2. 再利用性</h2></section><section><ul><li>ありものを使える</li><li>作ったものをあとから使える</li></ul></section><section><h3 id=ルーターフレームワーク>ルーター・フレームワーク</h3><ul><li>itty-router</li><li>Sunder</li><li>worktop</li><li>Hono</li></ul><p>Service Worker互換なので「Cloudflare Workers向け」を謳っているものも使える</p></section><section><h2 id=hono炎>Hono[炎]</h2><blockquote><p>Hono[炎] - Ultrafast web framework for Cloudflare Workers ( and Fastly Compute@Edge ).</p></blockquote><p>yusukebe/hono: Hono[炎] - Ultrafast web framework for Cloudflare Workers.<br><a href=https://github.com/yusukebe/hono>https://github.com/yusukebe/hono</a></p></section><section><p><img src=ss07.png alt=SS></p></section><section><ul><li>ルーティング</li><li>Request/Responseへのショートカット</li><li>Middleware</li></ul></section><section><h3 id=basic>Basic</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Hono</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;hono&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Hono</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, (<span style=color:#a6e22e>c</span>) =&gt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#39;Compute@Edge!!!&#39;</span>))
</span></span></code></pre></div></section><section><h3 id=custom-middleware>Custom Middleware</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#39;*&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ua</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#39;User-Agent&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>next</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ua</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/MalBot/</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#39;Forbidden&#39;</span>, <span style=color:#ae81ff>403</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></section><section><h3 id=built-in-middleware>Built-in Middleware</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;/auth/*&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>basicAuth</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;compute&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;edge&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hashFunction</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>m</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>) =&gt; <span style=color:#a6e22e>SHA256</span>(<span style=color:#a6e22e>m</span>).<span style=color:#a6e22e>toString</span>(),
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/auth/*&#39;</span>, (<span style=color:#a6e22e>c</span>) =&gt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#39;You are authorized!&#39;</span>))
</span></span></code></pre></div></section><section><ul><li>basic-auth</li><li>body-parse</li><li>cookie</li><li>cors</li><li>etag</li><li>graphql-server</li><li>logger</li><li>mustache</li><li>powered-by</li><li>serve-static*</li></ul></section><section><h3 id=with-backend>With Backend</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/backend&#39;</span>, (<span style=color:#a6e22e>c</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backendResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>req</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>Request</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>backend</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;origin_a&#39;</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>backendResponse</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></section><section><p>さらに、同じコードがCloudflare Workersで動くこともある</p></section><section><p>Codeである意味</p><h2 id=3-仮想環境>3. 仮想環境</h2></section><section><p>Fastly CLI / Viceroy</p></section><section><p>開発からデプロイまで</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>$ fastly compute serve
</span></span><span style=display:flex><span>$ fastly compute deploy
</span></span></code></pre></div></section><section><h2 id=vclにはない>VCLにはない</h2><ul><li>手元で動かせる</li><li>デプロイが早い・速い</li><li>Terraform => Fastly CLI</li><li><em>＊ただしバックエンドのキャッシュをエミュレートしない</em></li></ul></section><section><p>Codeである意味</p><h2 id=4-テスト>4. テスト</h2></section><section><h3 id=ユニットテストができる>ユニットテストができる</h3></section><section><h3 id=jestによるテスト>Jestによるテスト</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;GET /&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>request</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;Access control for a Bot&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;User-Agent&#39;</span>, <span style=color:#e6db74>&#39;MalBot/0.01&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>403</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></section><section><h2 id=ciでテストデプロイもできる>CIでテスト、デプロイもできる</h2><p>例: GitHub Actionsからデプロイする</p><p>fastly/compute-actions: GitHub Actions for building on Compute@Edge.<br><a href=https://github.com/fastly/compute-actions>https://github.com/fastly/compute-actions</a></p><p><em>(日経新聞さんはVCLをCI/CDしている！)</em></p></section><section><h2 id=ただし>ただし</h2><p>バックエンドのユニットテストができない</p><p>Viceroyレベルでテストしなくてはいけない = E2Eっぽいテストになる</p></section><section><h3 id=開発サーバーを立ち上げてfetchする>開発サーバーを立ち上げて<code>fetch</code>する</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URL</span>(<span style=color:#e6db74>&#39;http://127.0.0.1:7676/&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;GET &#34;/&#34;&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;GET &#34;/banana&#34;&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/banana&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></section><section><h3 id=cloudflare-wokersの場合>Cloudflare Wokersの場合</h3><p>Jest Environment · Miniflare
<a href=https://miniflare.dev/testing/jest>https://miniflare.dev/testing/jest</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#75715e>// jest.config.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>testEnvironment</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;miniflare&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>testEnvironmentOptions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bindings</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>KEY</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;value&#34;</span> },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kvNamespaces</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;TEST_NAMESPACE&#34;</span>],
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><section><h2 id=codeだからこそ>Codeだからこそ</h2><ol><li>「標準」を使える => Service Worker/TS</li><li>再利用性が高い => フレームワーク</li><li>仮想環境がある => Viceroy</li><li>テストができる => Jest/CI</li></ol></section><section><h1 id=3-性能>3. 性能</h1></section><section><h2 id=パフォーマンス計測>パフォーマンス計測</h2><ol><li>VCL vs Compute@Edge</li><li>Compute@Edgeの実装別</li></ol></section><section><h3 id=1-vcl-vs-computeedge>1. VCL vs Compute@Edge</h3><ul><li>VCL</li><li>Compute@Edge JavaScript</li><li>Compute@Edge Rust</li><li><del>Compute@Edge AssemblyScript</del></li></ul><p>Synthetic Response</p></section><section><h2 id=計測方法>計測方法</h2></section><section><p>VCLはローカルで動かせないので、オンラインのホストを叩く</p><ul><li><code>https://vcl.freetls.fastly.net/</code></li><li><code>https://is-js-fast.edgecompute.app/</code></li><li><code>https://is-rust-fast.edgecompute.app/</code></li></ul></section><section><p>ネットワーク以外でも差が出てしまう<br>(この場合はVCLのホストが遅い)</p><ul><li><strong>DNS</strong></li><li><strong>SSL</strong></li></ul></section><section><h2 id=ttfbで計測する>TTFBで計測する</h2><p>なるべく純粋な「反応速度」</p></section><section><p><img src=ss08.png alt=SS></p><p>Timing web requests with cURL and Chrome
<a href=https://blog.cloudflare.com/a-question-of-timing/>https://blog.cloudflare.com/a-question-of-timing/</a></p></section><section><p>同じネットワーク環境でかつ</p><p><code>curl</code>の「<code>time_starttransfer - time_appconnect</code>」で比べる</p></section><section><p>ttfb.sh<br><a href=https://github.com/jaygooby/ttfb.sh>https://github.com/jaygooby/ttfb.sh</a></p></section><section><p>では計測</p></section><section><h3 id=vcl---7ms>VCL - 7ms</h3><p><img src=vcl.png alt=VCL></p></section><section><h3 id=compute-js---18ms>Compute JS - 18ms</h3><p><img src=cejs.png alt=JS></p></section><section><h3 id=compute-rust---12ms>Compute Rust - 12ms</h3><p><img src=cerust.png alt=Rust></p></section><section><h3 id=順位>順位</h3><ol><li>VCL - 7ms</li><li>Compute Rust - 12ms</li><li>Compute JS - 18ms</li></ol></section><section><p>何回計測しても順位は変わらず</p><p>結構差がついた</p></section><section><h3 id=2-computeedgeの実装別>2. Compute@Edgeの実装別</h3><ul><li>Hono</li><li>itty-router</li></ul><p>kwhitley/itty-router: A little router.<br><a href=https://github.com/kwhitley/itty-router>https://github.com/kwhitley/itty-router</a></p><p>論理的にはHonoの方が格段に速い</p></section><section><p>オンラインだと差が出にくいので、ローカルサーバーを叩く</p></section><section><h3 id=hono--2054-reqssec-195ms>Hono => 2054 Reqs/sec, 1.95ms</h3><p><img src=hono.png alt=Hono></p></section><section><h3 id=itty-router--1779-reqssec-225ms>itty-router => 1779 Reqs/sec, 2.25ms</h3><p><img src=itty.png alt=itty></p></section><section><p>Compute@Edge同士ならややルーターで差が出る</p></section><section><h2 id=性能まとめ>性能まとめ</h2><ul><li>VCL速い(Wasm/Lucetとの差？)</li><li>ComputeでもJSよりRustの方が速い(Wasmにした時の違い？)</li><li>JS同士ならルーターの性能差がでる</li></ul><p>=> <strong>Compute@Edgeが速くなって、Wasmにした時でもRustと同等になって、速いルーターを使えばよい</strong></p></section><section><p>以上、Compute@Edgeについて</p><ol><li>機能</li><li>開発</li><li>性能</li></ol></section><section><p>「Compute@EdgeはVCLに置き換わるのか？」</p></section><section><h1 id=評価>評価</h1></section><section><ol><li>機能 => ○</li><li>開発 => ◎</li><li>性能 => △</li></ol></section><section><p>いわくら「（VCLだとプロパティ・関数の名称を）いちいち調べてる」</p><p>わだ「Compute@EdgeだとVSCodeで補完が効く」</p><p>いわくら「！！！！」</p></section><section><h1 id=まとめ>まとめ</h1><p>(パフォーマンスがVCLに近づけば)</p><p>「Compute@EdgeはVCLに置き換わる」</p><p>そして【VCL以上】の体験を手に入れる</p></section><section><p>正式リリースに期待！</p><ul><li>Rust - Limited Availability</li><li>JavaScript - BETA</li></ul></section><section><p>おしまい</p></section><section><p>トラベルブックではエンジニア募集中！</p><p>Fastlyガンガン使ってます</p><p>Compute@Edgeも導入するかもしれません！</p></section><section><p>TravelBook Tech Blog</p><p><a href=https://tech.travelbook.co.jp/>https://tech.travelbook.co.jp/</a></p></section></div></div><script type=text/javascript src=/slides/reveal-hugo/object-assign.js></script>
<a href=/slides/reveal-js/css/print/ id=print-location style=display:none></a>
<script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>{"custom_theme":"stylesheets/custom-theme.scss","custom_theme_compile":true}</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=/slides/reveal-js/js/reveal.js></script>
<script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=/slides/reveal-js/plugin/markdown/marked.js></script>
<script type=text/javascript src=/slides/reveal-js/plugin/markdown/markdown.js></script>
<script type=text/javascript src=/slides/reveal-js/plugin/highlight/highlight.js></script>
<script type=text/javascript src=/slides/reveal-js/plugin/zoom-js/zoom.js></script>
<script type=text/javascript src=/slides/reveal-js/plugin/notes/notes.js></script></body></html>